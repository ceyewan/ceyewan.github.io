模型上下文协议（MCP）采用客户端 - 主机 - 服务器架构，其中每个主机可以运行多个客户端实例。这种架构使用户能够在跨应用程序集成 AI 功能的同时，保持清晰的安全边界并隔离关注点。MCP 基于 JSON-RPC，提供一种面向上下文交换和客户端与服务器之间采样协调的状态化会话协议。

## 三大组件

主机进程是 MCP 协议的核心协调器。它负责管理客户端实例的生命周期，控制连接权限，并执行安全策略。主机还负责协调 AI/LLM 集成，确保整个系统的顺畅运行。

- 管理客户端实例的生命周期
- 控制连接权限并实施安全策略
- 协调 AI/LLM 集成
- 确保系统稳定性

客户端由主机创建，以与服务器保持独立连接。每个客户端与一个服务器保持 1:1 的关系，确保连接的隔离性和安全性。

- 与服务器保持独立连接
- 建立有状态的会话
- 处理协议协商
- 管理消息路由

服务器负责公开资源和工具。它们可以独立运行，并通过客户端处理采样请求。服务器可以是本地的或远程的，为系统提供各种功能。

- 暴露特定的资源和工具
- 运行和独立管理
- 通过客户端处理请求
- 支持本地和远程服务

## 生命周期

MCP 为客户端 - 服务器连接定义了严格的生命周期，确保正确的能力协商和状态管理。

### 初始化阶段

初始化阶段必须是客户端和服务器之间的第一次交互。在此阶段，双方：

- 建立协议版本兼容性
- 交换和协商能力
- 共享实现细节

## 传输机制

MCP 目前定义了两种标准的客户端 - 服务器通信传输机制：stdio（标准输入输出）和基于 SSE 的 HTTP。客户端应尽可能支持 stdio。此外，客户端和服务器也可以以可插拔的方式实现自定义传输机制。

### 标准输入输出

在 stdio 传输机制中：

- 客户端将 MCP 服务器作为子进程启动
- 服务器通过标准输入（stdin）接收 JSON-RPC 消息，并通过标准输出（stdout）写入响应
- 消息以**换行符分隔**，且**不能包含嵌入的换行符**
- 服务器可以将 UTF-8 字符串写入标准错误（stderr）用于日志记录。客户端可以捕获、转发或忽略这些日志
- 服务器不能向标准输出写入任何非有效 MCP 消息的内容
- 客户端不能向服务器的标准输入写入任何非有效 MCP 消息的内容

### 基于 SSE 的 HTTP

在 SSE 传输机制中，服务器作为独立进程运行，可以处理多个客户端连接。服务器必须提供两个端点

- SSE 端点 - 用于客户端建立连接并接收来自服务器的消息
- HTTP POST 端点 - 用于客户端向服务器发送消息

当客户端连接时，服务器必须发送一个包含客户端用于发送消息的 URI 的 endpoint 事件；所有后续的客户端消息必须作为 HTTP POST 请求发送到此端点；服务器消息作为 SSE message 事件发送，消息内容以 JSON 格式编码在事件数据中。

## 服务器功能

服务器提供了通过 MCP 将上下文添加到语言模型的基本构建块，提供了三个基本原语来管理上下文：提示词、资源和工具。

| 原语  | 控制    | 描述         | 示例           |
| :-- | :---- | :--------- | :----------- |
| 提示词 | 系统    | 定义模型的行为和角色 | 你是一个专业的代码审查者 |
| 资源  | 用户    | 提供额外的上下文信息 | 代码文件、文档      |
| 工具  | 系统/用户 | 扩展模型的能力    | 代码搜索、文件编辑    |
