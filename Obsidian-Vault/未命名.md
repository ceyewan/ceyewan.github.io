试用了一下兄弟团队提供的两个 mcp-server，简单记录一下。

## Observability MCP Server

`Observability MCP Server` 是一个需要本地部署的工具，源代码地址为：[observability-mcp-server](https://github.com/aliyun/alibabacloud-observability-mcp-server) 。

在使用过程中，需创建 RAM 用户并授予以下权限：

- `AliyunLogFullAccess`：用于访问日志服务 (SLS)
- `AliyunARMSFullAccess`：用于访问应用实时监控服务 (ARMS)

通信安全性方面，LLM 与阿里云之间的通信是安全的，但客户端到 LLM 的通信不安全，建议通过内网部署或自行增加安全措施保障通信。

主要提供了 sls 和 arms 查询的相关 Tools，下面是本次调研使用到了的一些工具：

| 工具名称                                  | 功能描述                  |
| ------------------------------------- | --------------------- |
| `MCP_sls_list_logstores`              | 列出指定 SLS 项目的日志库       |
| `MCP_sls_describe_logstore`           | 获取日志库结构信息（字段、索引等）     |
| `MCP_sls_translate_text_to_sql_query` | 将自然语言转换为 SLS SQL 查询语句 |
| `MCP_sls_execute_sql_query`           | 执行 SLS SQL 查询并返回结果    |
| `MCP_cms_translate_text_to_promql`    | 将自然语言转换为 PromQL 查询语句  |
| `MCP_cms_execute_promql_query`        | 执行 PromQL 查询并返回结果     |

在我的具体使用过程中，需要**输入尽可能详细的上下文 + 明确的意图表达**，才能够获取到想要的信息。

用户可能知道的是集群名 yingxi-openapi-mcp-test，但是需要的是集群 ID 和对应的日志库 k8s-log-{ID} 用于调用工具。如果只是给定集群名，没有 ID 信息，mcp-Server 只能全局搜索才能获取那个日志 Project 和集群是关联的。日志库中内容特别多，如果全文检索很容易就爆大模型的 Token Limit 了。

可观测团队提供了 `sls_translate_text_to_sql_query` 和 `MCP_cms_translate_text_to_promql` 这两个方法，用于将 Prompt 中的自然语言转换为 SLS 支持的 SQL 查询语句和 PromQL 语句。因此，合适的 Prompt 就显得很重要了：

```txt
我希望查询集群【集群 ID】在【时间范围】内的【指标类型】，对象是【具体资源（如 Deployment、Pod 名称等）】，数据应该来自【具体的日志库或监控源】，并且希望得到【展示形式（表格、图表等）】。
```

这样的话，上面的这两个工具才能生成很精确的查询语句，查询得到信息密度高的结果。正常来说需要提供的基础信息如下：

- **SLS 场景**
    - Project（项目名）
    - LogStore（日志库名称）
    - RegionId（地域 ID）
- **ARMS/CMS 场景**
    - Project（Prometheus 实例所在项目）
    - MetricStore（Prometheus 实例名）
    - RegionId（地域 ID）

此外，日志库中的 logstore 需要更具有描述性的提示，才能让 LLM 准确定位到应该使用哪一个，比如下面这个例子，LLM 的推测既有正确的部分也有不正确的部分。用户一般不同这些内容，因此需要在 System Prompt 中写明。

![[Pasted image 20250619201533.png]]

**Prompt**："SLS 项目名称是 k8s-log-c9a6d040fdaa7417eaf0407cf0bee4c7e，区域 ID 是 ap-southeast-1，查询最近一小时内的 Pod 创建事件 "

**生成的 SQL 查询语句**：

```sql
"eventId.involvedObject.kind" = 'Pod' AND "eventId.reason" = 'Created' | SELECT "eventId.involvedObject.name" AS pod_name, "eventId.involvedObject.namespace" AS namespace, "eventId.message" AS message, "eventId.eventTime" AS event_time FROM log
```

**查询结果**：

![[Pasted image 20250619202232.png]]

>[!NOTE]
>若进一步指定命名空间或关键词（如 `hellok8s-deployment`），查询会更精准。

基于 ARMS 获取集群的监控信息，需要告诉 LLM 能够连接上 ARMS 监控服务的**连接信息**，获取 ARMS 监控数据的流程如下：

1. `sls_get_current_time` 获取当前时间戳确定查询范围
2. `cms_translate_text_to_promql` 将自然语言翻译成 PromQL 查询语句
3. `cms_execute_promql_query` 执行查询语句，需要以下参数执行查询：
    - **Project**: `workspace-default-cms-1840724847576507-ap-southeast-1`
    - **MetricStore**: `aliyun-prom-c9a6d040fdaa7417eaf0407cf0bee4c7e`
    - **Query**: `sum(rate(container_cpu_usage_seconds_total{pod=~"hellok8s-deployment-.*", namespace="default"}[5m])) by (pod)`
    - **fromTimestampInSeconds**: `1750299741`
    - **toTimestampInSeconds**: `1750303341`
    - **RegionId**: `ap-southeast-1`

该工具可用性较高，适用于日志分析和监控数据获取场景。

## OpenAPI MCP Server

`OpenAPI MCP Server` 不需要本地部署，而是直接在服务器上创建。客户端需通过 OAuth 认证连接后即可使用。

目前存在的主要问题是**响应速度慢**，一次交互可能需要几分钟完成。LLM 单独执行速度较快，初步猜测可能是 MCP Host 和 MCP Server 之间的交互较慢，例如认证加解密 + 交互数据量大导致执行缓慢。当前支持 OAuth 认证的客户端（CherryStudio），官方推荐使用此客户端，但性能不佳。

>[!NOTE] TODO
>换用不同的客户端，深入分析调用耗时，诊断并解决问题。

![[Pasted image 20250620095652.png]]

**Tool 数量限制**，Kubernetes OpenAPI 共有 128 个接口，而每个 MCP Server 最多支持 30 个工具。需筛选重要 API 或部署多个 MCP Server（部署多个 MCP Server 可能会导致响应速度问题更加严重）。

**参数处理问题**，某些 API 同时包含必填和可选参数，例如创建集群时，必填参数是下面 4 个（cluster_type 不支持专有版，只能是 ManagedKubernetes，创建后再迁移到 Pro 版）。当前的问题是 LLM 可能编造不存在的可选参数值，导致调用工具失败或创建的集群不可用。**建议**在 Prompt 中应明确指定可选参数为空或使用默认值。

```json
{
  "body": {
    "name": "yingxi-mcp-test-1",
    "region_id": "cn-beijing",
    "cluster_type": "ManagedKubernetes",
    "service_cidr": "172.21.0.0/20"
  }
}
```

**异步操作影响后续调用问题**，每次 MCP Tool 调用，只是提交了一个任务，如创建集群、迁移到 Pro 版、升级 Kubernetes 版本等操作，实际在后台执行时间较长。这就会导致 LLM 的后续工具调用会失败，影响用户体验。这个问题不太能避免，建议在响应中提醒用户操作耗时较长，并避免 LLM 多次尝试失败调用。

## 总结

- **Observability MCP Server** 可用性很高，日志分析和监控数据获取两个方面使用体验良好，响应很迅速，在工程上提供详细上下文和参数输入来确保准确性即可。
- **OpenAPI MCP Server** 将所有的 OpenAPI 统一转化为了方便 LLM 使用的 MCP Tool，但是现在的核心问题就是响应速度慢，需进一步优化。提示词工程主要需要解决参数的幻觉问题和多次调用的连贯性问题。
